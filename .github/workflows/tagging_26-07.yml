name: Create Release Tag

on:
  pull_request:
    types:
      - closed

jobs:
  create-tag:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Determine tag version
        id: determine_version
        run: |
          git checkout main
          git pull origin main
          previous_version=$(cat version.txt)
          echo "Current version: $previous_version"

          # Read the updated version.txt from the pull request branch
          git checkout ${{ github.event.pull_request.head.ref }}
          git pull origin ${{ github.event.pull_request.head.ref }}
          updated_version=$(cat version.txt)
          echo "Updated version: $updated_version"

          major_keyword='MAJOR/major'
          minor_keyword='MINOR/minor'
          patch_keyword='PATCH/patch'

          if [[ "$updated_version" == *"$major_keyword"* ]]; then
            new_version=$(echo $previous_version | sed -E 's/v([0-9]+)\.([0-9]+)\.([0-9]+)/\1/')
            new_version=$((new_version + 1))
            new_tag="v${new_version}.0.0"
          elif [[ "$updated_version" == *"$minor_keyword"* ]]; then
            new_version=$(echo $previous_version | sed -E 's/v([0-9]+)\.([0-9]+)\.([0-9]+)/\2/')
            new_version=$((new_version + 1))
            new_tag=$(echo $previous_version | sed -E "s/v[0-9]+\.[0-9]+\.[0-9]+/v0.${new_version}.0/")
          elif [[ "$updated_version" == *"$patch_keyword"* ]]; then
            new_version=$(echo $previous_version | sed -E 's/v([0-9]+)\.([0-9]+)\.([0-9]+)/\3/')
            new_version=$((new_version + 1))
            new_tag=$(echo $previous_version | sed -E "s/v[0-9]+\.[0-9]+\.[0-9]+/v0.0.${new_version}/")
          else
            echo "No keyword found in the updated version.txt. Skipping tag creation."
            exit 0
          fi

          echo "New tag version: $new_tag"
          echo $new_tag > version.txt
          echo "::set-output name=new_tag::$new_tag"

      - name: Create Git tag
        if: steps.determine_version.outputs.new_tag != 'v0.0.0'
        run: |
          git tag ${{ steps.determine_version.outputs.new_tag }}
          git push origin ${{ steps.determine_version.outputs.new_tag }}
